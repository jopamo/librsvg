#include <config.h>
#include <stdlib.h>
#include <string.h>
#include <glib.h>
#include "rsvg.h"
#include "test-utils.h"

static void test_metadata_injection(void) {
    const char* svg_content =
        "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"
        "<svg xmlns=\"http://www.w3.org/2000/svg\">"
        "<metadata injection = '&quot; onload=&quot;alert(1)' />"
        "</svg>";

    GError* error = NULL;
    RsvgHandle* handle = rsvg_handle_new_from_data((const guint8*)svg_content, strlen(svg_content), &error);
    g_assert_no_error(error);
    g_assert(handle != NULL);

    const char* metadata = rsvg_handle_get_metadata(handle);
    g_assert(metadata != NULL);

    g_test_message("Metadata: %s", metadata);

    /* Check if the output is malformed/injected */
    /* Expected safe output: injection=\"&quot; onload=&quot;alert(1)\" or similar escaped version */
    /* Vulnerable output: injection=\"\" onload=\"alert(1)\" */

    if (strstr(metadata, "injection=\"\" onload=\"alert(1)\"") != NULL) {
        g_test_fail_printf("Vulnerability confirmed: Metadata injection successful.\nGot: %s", metadata);
    }
    else {
        /* Check if it IS escaped correctly (e.g. &quot;) */
        /* Note: glib might use different escaping or rsvg might not escape at all but use single quotes if smart?
           But the code used "%s=\" %s \" ". Hardcoded double quotes. */
        if (strstr(metadata, "injection=\"&quot;") == NULL && strstr(metadata, "injection=\"&#34;") == NULL) {
            /* If it's not the exact injection string but also not escaped, it might be just broken syntax like
             * injection=\"\"" */
            /* The input value is `" onload="alert(1)` */
            /* The code prints `injection="` + value + `"` */
            /* So `injection=\"\" onload=\"alert(1)\""` */
            char* expected_bad = "injection=\"\" onload=\"alert(1)\"";
            if (strstr(metadata, expected_bad)) {
                g_test_fail_printf("Vulnerability confirmed: %s", metadata);
            }
        }
    }

    g_object_unref(handle);
}

int main(int argc, char** argv) {
    g_test_init(&argc, &argv, NULL);
    g_test_add_func("/security/metadata-injection", test_metadata_injection);
    return g_test_run();
}
